import boto3
import csv
import io

def lambda_handler(event, context):
    # Connect to the Lambda and S3 services
    lambda_client = boto3.client('lambda')
    s3 = boto3.client('s3')

    # Get the list of functions in your AWS account
    functions = []
    response = lambda_client.list_functions()
    functions += response['Functions']
    while 'NextMarker' in response:
        response = lambda_client.list_functions(Marker=response['NextMarker'])
        functions += response['Functions']

    # Create a CSV file with the details of each function
    file = io.StringIO()
    writer = csv.DictWriter(file, fieldnames=['FunctionName', 'Runtime', 'MemorySize', 'Region', 'ProvisionedConcurrency', 'EphemeralStorage'])
    writer.writeheader()
    for function in functions:
        function_details = lambda_client.get_function_configuration(FunctionName=function['FunctionName'])
        function_data = {
            'FunctionName': function_details['FunctionName'],
            'Runtime': function_details['Runtime'],
            'MemorySize': function_details['MemorySize'],
            'Region': function['FunctionArn'].split(":")[3],
            'ProvisionedConcurrency': 'N/A',
            'EphemeralStorage': 'N/A'
        }
        if 'ProvisionedConcurrency' in function_details:
            function_data['ProvisionedConcurrency'] = function_details['ProvisionedConcurrency']
        if 'XrayConfig' in function_details and 'Bucket' in function_details['XrayConfig']:
            function_data['EphemeralStorage'] = function_details['XrayConfig']['Bucket']
        writer.writerow(function_data)
    
    # Store the report in an S3 bucket
    file.seek(0)
    s3.put_object(Bucket='hellokeke', Key='functions.csv', Body=file.read().encode('utf-8'))
